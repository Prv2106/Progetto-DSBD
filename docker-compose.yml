services: 
  db:
    build:
      context: ./DB
      dockerfile: dockerfile-mysql
    networks:
      - net1
      - net2
    volumes: 
      - db_vol:/var/lib/mysql
    container_name: mysql_container

  data-collector:
    build:
      context: .
      dockerfile: DataCollector/dockerfile-datacollector
    depends_on:
      - db
    networks:
      - net2
    container_name: break_collector_container
    restart: always
    
  server-grpc:
    build:
      context: .
      dockerfile: gRPC/dockerfile-server
    depends_on:
      - db
    networks:
      - net1
    container_name: grpc_server_container
    ports:
      - "50051:50051"
    restart: always


  # Zookeeper (per Kafka)
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: zookeeper_container
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - net2
    restart: always

  # Kafka Broker
  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: kafka_container
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - net2
    ports:
      - "9092:9092"
    restart: always
    volumes:
      - kafka_data:/var/lib/kafka/data  # Volume per la persistenza dei dati Kafka

  # AlertSystem
  alert-system:
    build:
      context: .
      dockerfile: dockerfile-alertsystem
    depends_on:
      - kafka
      - db
    networks:
      - net2
    container_name: alert_system_container
    restart: always

  # AlertNotifierSystem
  alert-notifier-system:
    build:
      context: ./AlertNotifierSystem
      dockerfile: dockerfile-notifier
    depends_on:
      - kafka
    networks:
      - net2
    container_name: alert_notifier_container
    restart: always

networks:
  net1:
    driver: bridge
  net2: 
    driver: bridge

volumes:
  db_vol:  
    driver: local
  kafka_data:
    driver: local